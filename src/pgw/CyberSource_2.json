{
  "gateway_type": "CyberSource",
  "gateway_version": "2",
  "display_name": "CyberSource v2",
  "gateway_revision": 1,
  "status": "Draft",
  "request_language": "Raw",
  "card_types": [
    "Visa",
    "MasterCard",
    "AmericanExpress",
    "Discover",
    "Diners",
    "JCB"
  ],
  "idempotency_support": {
    "key_spec": "UUIDv4",
    "retry_window_opened_at": 300,
    "retry_window_closed_at": 144000
  },
  "mit_support_list": [
    {
      "payment_method_type": "CreditCard",
      "brand": "Visa",
      "profile_types": ["Recurring"]
    },
    {
      "payment_method_type": "CreditCard",
      "brand": "Mastercard",
      "profile_types": ["Recurring"]
    },
    {
      "payment_method_type": "CreditCard",
      "brand": "AmericanExpress",
      "profile_types": ["Recurring"]
    },
    {
      "payment_method_type": "CreditCard",
      "brand": "Discover",
      "profile_types": ["Recurring"]
    },
    {
      "payment_method_type": "CreditCard",
      "brand": "Diners",
      "profile_types": ["Recurring"]
    },
    {
      "payment_method_type": "CreditCard",
      "brand": "JCB",
      "profile_types": ["Recurring"]
    }
  ],
  "moto_support_list": [
    {
      "payment_method_type": "CreditCard",
      "allow_create_scp": true
    }
  ],
  "global_fields": [
    {
      "field_name": "Header-Content-Type",
      "field_value_expression": "application/json"
    },
    {
      "field_name": "Header-Authorization",
      "field_value_expression": "Bearer #{if}($StringUtils.isNotBlank($OAuth2Token))$!OAuth2Token#{else}$!SecretKey#{end}"
    },
    {
      "field_name": "Header-v-c-merchant-id",
      "field_value_expression": "$!MerchantId"
    }
  ],
  "operations": [
    {
      "operation_name": "Authorization",
      "operation_type": "Authorization",
      "transactions": [
        {
          "transaction_name": "ProcessPayment",
          "connector_type": "HTTPs",
          "transaction_request_fields": [
            {
              "field_name": "URL",
              "field_value_expression": "https://apitest.cybersource.com/pts/v2/payments"
            },
            {
              "field_name": "METHOD",
              "field_value_expression": "POST"
            },
            {
              "field_name": "Content-Type",
              "field_value_expression": "${Header-Content-Type}"
            },
            {
              "field_name": "Authorization",
              "field_value_expression": "${Header-Authorization}"
            },
            {
              "field_name": "v-c-merchant-id",
              "field_value_expression": "${Header-v-c-merchant-id}"
            },
            {
              "field_name": "REQUEST_BODY",
              "field_value_expression": "{\"clientReferenceInformation\":{\"code\":\"$ZUtility.getUUID(32)\"},\"paymentInformation\":{\"card\":{\"number\":\"$!CreditCardNumber\",\"expirationMonth\":\"$!CreditCardExpirationMonth\",\"expirationYear\":\"$!CreditCardExpirationYear\",\"securityCode\":\"$!CreditCardSecurityCode\"}},\"orderInformation\":{\"amountDetails\":{\"totalAmount\":\"$!Amount\",\"currency\":\"$!Currency\"},\"billTo\":{\"firstName\":\"$!FirstName\",\"lastName\":\"$!LastName\",\"address1\":\"$!CreditCardAddress1\",\"locality\":\"$!CreditCardCity\",\"administrativeArea\":\"$!CreditCardState\",\"postalCode\":\"$!CreditCardPostalCode\",\"country\":\"$!CreditCardCountry\",\"email\":\"$!Email\"}},\"processingInformation\":{\"capture\":false,\"commerceIndicator\":\"internet\"}}"
            }
          ],
          "request_to_log": "Request = [CyberSource Payment Authorization; URL = $!URL]",
          "transaction_response_fields": [
            {
              "field_name": "ResponseBody",
              "field_value_expression": "$!last_message_body"
            },
            {
              "field_name": "ResponseCode",
              "field_value_expression": "$!last_status_code"
            }
          ],
          "response_fsm_event_expression": "#{if}($StringUtils.equals($last_status_code, '201'))Success#{else}Error#{end}"
        }
      ],
      "operation_states": [
        {
          "start_state": "BEGIN",
          "transaction_event": "",
          "end_state": "ProcessPayment"
        },
        {
          "start_state": "ProcessPayment",
          "transaction_event": "Success",
          "end_state": "END"
        },
        {
          "start_state": "ProcessPayment",
          "transaction_event": "Error",
          "end_state": "END"
        }
      ],
      "operation_response_fields": [
        {
          "field_name": "ZuoraResponseCode",
          "field_value_expression": "#{if}($StringUtils.equals($last_status_code, '201'))Approved#{else}Failed#{end}"
        },
        {
          "field_name": "GatewayResponseCode",
          "field_value_expression": "$!last_status_code"
        },
        {
          "field_name": "GatewayResponseMessage",
          "field_value_expression": "#{if}($StringUtils.equals($last_status_code, '201'))Payment Authorized#{else}Payment Failed#{end}"
        },
        {
          "field_name": "GatewayReferenceId",
          "field_value_expression": "$ZUtility.parseJsonDocument($last_message_body).valueOf('/JsonRoot/id')"
        }
      ]
    }
  ]
}
